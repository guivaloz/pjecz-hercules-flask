{% extends 'layouts/app.jinja2' %}
{% import 'macros/form.jinja2' as f with context %}
{% import 'macros/topbar.jinja2' as topbar %}

{% block title %}Firmar Oficio {{ ofi_documento.descripcion | truncate(48) }}{% endblock %}

{% block custom_head %}
    <!-- Estilos del contenido para poner bordes y margenes a las tablas -->
    <link rel="stylesheet" href="https://storage.googleapis.com/pjecz-informatica/static/css/ckeditor5-justicia-digital-gob-mx.css">
{% endblock %}

{% block topbar_actions %}
    {% call topbar.page_buttons('Firmar ' + ofi_documento.descripcion | truncate(32)) %}
        {{ topbar.button('Ver en Monitor', url_for('ofi_documentos.fullscreen', ofi_documento_id=ofi_documento.id), "mdi:monitor") }}
        {{ topbar.button('Ver en Celular', url_for('ofi_documentos.detail', ofi_documento_id=ofi_documento.id), "mdi:cellphone") }}
        {{ topbar.button('Mi Bandeja de Entrada', url_for('ofi_documentos.list_active_mi_bandeja_entrada'), "mdi:inbox-multiple") }}
        {% if mostrar_boton_mis_oficios %}
            {{ topbar.button_previous('Mis Oficios', url_for('ofi_documentos.list_active_mis_oficios')) }}
        {% endif %}
        {% if mostrar_boton_mi_autoridad %}
            {{ topbar.button('Mi Autoridad', url_for('ofi_documentos.list_active_mi_autoridad'), "mdi:scale-balance") }}
        {% endif %}
        {% if current_user.can_admin('OFI DOCUMENTOS') %}
            {{ topbar.button('Administrar', url_for('ofi_documentos.list_active_admin'), "mdi:folder") }}
        {% endif %}
        {% if current_user.can_admin('OFI PLANTILLAS') %}
            {{ topbar.button('Plantillas', url_for('ofi_plantillas.list_active'), "mdi:note-multiple") }}
        {% endif %}
        {% if current_user.can_edit('OFI DOCUMENTOS') %}
            {% if mostrar_boton_editar and ofi_documento.estado == "BORRADOR" and not ofi_documento.esta_cancelado %}
                {{ topbar.button_edit('Editar', url_for('ofi_documentos.edit', ofi_documento_id=ofi_documento.id)) }}
            {% endif %}
        {% endif %}
        {% if current_user.can_admin('OFI DOCUMENTOS') %}
            {% if ofi_documento.estatus == 'A' %}{{ topbar.button_delete('Eliminar', url_for('ofi_documentos.delete', ofi_documento_id=ofi_documento.id)) }}{% endif %}
            {% if ofi_documento.estatus == 'B' %}{{ topbar.button_recover('Recuperar', url_for('ofi_documentos.recover', ofi_documento_id=ofi_documento.id)) }}{% endif %}
        {% endif %}
    {% endcall %}
{% endblock %}

{% block content %}
    {% call f.card() %}
        {% set form_kwargs = {'ofi_documento_id': ofi_documento.id} %}
        {% call f.form_tag('ofi_documentos.sign', fid='ofi_documento_form', **form_kwargs) %}
            {% call f.form_group(form.descripcion) %}{% endcall %}
            <div class="row">
                <div class="col-md-6">{% call f.form_group(form.folio, readonly=true) %}{% endcall %}</div>
                <div class="col-md-6">{% call f.form_group(form.vencimiento_fecha, readonly=true) %}{% endcall %}</div>
            </div>
            <!-- Inicia Contenido HTML -->
            <hr />
            {% if ofi_documento.contenido_html %}
                {{ ofi_documento.contenido_html | safe }}
            {% else %}
                <div class="alert alert-warning" role="alert">
                    <strong>Aviso:</strong> Este oficio no tiene contenido HTML.
                </div>
            {% endif %}
            <hr />
            <!-- Termina Contenido HTML -->
            {% call f.form_group(form.tipo) %}{% endcall %}
            <!-- Recomendaciones importantes -->
            <div class="card border-warning mt-2" id="recomendaciones_importantes">
                <div class="card-body" style="background-color: #fff3cd;">
                    <div class="card-title">
                        <strong>Después de firmar ya NO podrá editar NI cambiar el folio</strong>
                    </div>
                    <ul class="card-text mb-0">
                        <li>Revise cuidadosamente todo el contenido y que el folio sea correcto.</li>
                        <li>Después de firmar SÍ podrá cambiar la descripción, los archivos adjuntos y los destinatarios.</li>
                    </ul>
                    <a href="javascript:ocultarRecomendacionesImportantes()" class="btn btn-warning btn-sm mt-2">Ocultar</a>
                </div>
            </div>
            <!-- Botones -->
            <div class="row">
                <div class="col-md-3">
                    <a class="btn btn-block btn-md btn-warning w-100 my-2" href="{{ url_for('ofi_documentos.edit', ofi_documento_id=ofi_documento.id) }}">
                        <span class="iconify" data-icon="mdi:file-document-edit-outline"></span>
                        Editar
                    </a>
                </div>
                <div class="col-md-3">
                    <a class="btn btn-block btn-md btn-success w-100 my-2" href="javascript:firmaSimple()">
                        <span class="iconify" data-icon="mdi:file-sign"></span>
                        Firma Simple
                    </a>
                </div>
                <div class="col-md-3">
                    <a id="firmaElectronicaAvanzada" class="btn btn-block btn-md btn-primary w-100 my-2" href="javascript:firmaElectronicaAvanzada()">
                        <span class="iconify" data-icon="mdi:file-sign"></span>
                        Firma Electrónica Avanzada
                    </a>
                </div>
                <div class="col-md-3">
                    <a class="btn btn-block btn-md btn-outline-info w-100 my-2" href="javascript:history.back()">
                        <span class="iconify" data-icon="mdi:arrow-left"></span>
                        Regresar sin firmar
                    </a>
                </div>
            </div>
        {% endcall %}
    {% endcall %}
{% endblock %}

{% block custom_javascript %}
    <!-- Ocultar el aviso "Recomendaciones importantes" -->
    <script>
        function ocultarRecomendacionesImportantes() {
            var elemento = document.getElementById("recomendaciones_importantes");
            if (elemento) {
                elemento.style.display = "none";
            }
        }
    </script>
    <!-- Botones Editar, Firma Simple, Firma Electrónica Avanzada y Regresar sin firmar -->
    <script>
        // Prevenir el envío del formulario por defecto
        const formElem = document.getElementById('ofi_documento_form')
        formElem.addEventListener('submit', function(event) {
            event.preventDefault();
        });
        // Función para firmar con firma simple
        const tipoHiddenElem = document.getElementById('tipo')
        function firmaSimple() {
            tipoHiddenElem.value = 'simple';
            formElem.submit();
        }
        {% if not tiene_firma_electronica_avanzada %}
            // Ocultar el botón de firma electrónica avanzada
            const btnFirmaAvanzada = document.getElementById('firmaElectronicaAvanzada');
            btnFirmaAvanzada.style.display = 'none';
            // Función para mostrar mensaj porque NO tiene firma electrónica avanzada
            function firmaElectronicaAvanzada() {
                alert('No tiene firma electrónica avanzada configurada. Por favor, contacte al administrador.');
                return;
            }
        {% else %}
            // Función para firmar con firma electrónica avanzada
            function firmaElectronicaAvanzada() {
                tipoHiddenElem.value = 'avanzada';
                formElem.submit();
            }
        {% endif %}
    </script>
{% endblock %}
